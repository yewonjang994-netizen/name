<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì´ë¦„ ë½‘ê¸° ìˆ˜ì… ê²Œì„ (ë„ê°/ì˜¨ë¼ì¸ë­í‚¹)</title>
  <style>
    :root{
      --bg:#0b0f19; --card:#111a2e; --card2:#0c1326; --line:#223156; --line2:#2c3b66;
      --txt:#e9eefc; --muted:rgba(233,238,252,.82);
      --btn:#4b7bff;
      --ok:#22c55e; --off:#94a3b8;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--txt); }
    .wrap{ max-width: 1020px; margin:0 auto; padding: 24px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius: 18px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,.28); }
    h1{ margin:0 0 12px; font-size:22px; letter-spacing:-0.3px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    button{ border:0; border-radius:12px; padding:12px 14px; cursor:pointer; font-weight:900; }
    .btn{ background:var(--btn); color:white; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn2{ background:#1f2a46; color:var(--txt); border:1px solid var(--line2); }
    .stat{ display:flex; gap:14px; flex-wrap:wrap; margin-top: 12px; }
    .pill{ background:var(--card2); border:1px solid var(--line); border-radius:999px; padding:8px 12px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;}
    .small{ opacity:.86; font-size:13px; line-height:1.5; color:var(--muted); }
    .log{ margin-top:14px; padding:12px; border-radius:12px; background:var(--card2); border:1px solid var(--line); min-height: 120px; white-space: pre-wrap; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }

    /* rarity colors */
    .rare{ font-weight:1000; }
    .common{ color:#cbd5e1 } .rareT{ color:#60a5fa } .epic{ color:#a78bfa }
    .legend{ color:#fbbf24 } .myth{ color:#fb7185 }

    /* draw animation area */
    .stage{
      margin-top:14px;
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      padding:14px;
      overflow:hidden;
      position:relative;
      min-height:120px;
    }
    .spinText{
      font-weight:1000; font-size:18px;
      opacity:.92;
      transform: translateY(0);
      transition: transform .18s ease, opacity .18s ease;
    }
    .resultBig{
      margin-top:8px;
      font-size:20px;
      font-weight:1100;
      letter-spacing:-0.4px;
    }
    .spark{
      position:absolute; width:10px; height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.9);
      animation: pop 650ms ease-out forwards;
      pointer-events:none;
      opacity:.92;
      filter:blur(.1px);
    }
    @keyframes pop{
      0%{ transform: translate(0,0) scale(.9); opacity:.9; }
      100%{ transform: translate(var(--dx), var(--dy)) scale(0); opacity:0; }
    }

    /* shake levels */
    .shakeLegend{ animation: shakeLegend 700ms ease-in-out; }
    .shakeMyth{ animation: shakeMyth 900ms ease-in-out; }
    @keyframes shakeLegend{
      0%,100%{ transform: translate(0,0); }
      10%{ transform: translate(-10px, 6px); }
      20%{ transform: translate(9px, -7px); }
      30%{ transform: translate(-8px, -6px); }
      40%{ transform: translate(8px, 8px); }
      50%{ transform: translate(-6px, 7px); }
      60%{ transform: translate(6px, -6px); }
      70%{ transform: translate(-5px, 5px); }
      80%{ transform: translate(5px, -4px); }
      90%{ transform: translate(-3px, 3px); }
    }
    @keyframes shakeMyth{
      0%,100%{ transform: translate(0,0); }
      8%{ transform: translate(-14px, 9px); }
      16%{ transform: translate(13px, -10px); }
      24%{ transform: translate(-12px, -9px); }
      32%{ transform: translate(12px, 12px); }
      40%{ transform: translate(-10px, 11px); }
      48%{ transform: translate(10px, -10px); }
      56%{ transform: translate(-9px, 9px); }
      64%{ transform: translate(9px, -8px); }
      72%{ transform: translate(-7px, 7px); }
      80%{ transform: translate(7px, -6px); }
      88%{ transform: translate(-5px, 5px); }
      96%{ transform: translate(3px, -3px); }
    }

    /* flash overlay */
    .flash{
      position:fixed; inset:0; background:white; opacity:0;
      pointer-events:none;
      transition: opacity .12s ease;
      z-index:100;
    }
    .flash.on1{ opacity:.45; }
    .flash.on2{ opacity:.70; }

    /* modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index:50;
    }
    .modalBack.show{ display:flex; }

    /* âœ… ì—¬ê¸°ì„œ â€œëª¨ë‹¬ ìì²´ê°€ í™”ë©´ì— ë§ê²Œâ€ + â€œë‚´ë¶€ ìŠ¤í¬ë¡¤â€ */
    .modal{
      width:min(860px, 100%);
      max-height: 85vh;          /* í™”ë©´ë³´ë‹¤ í¬ë©´ */
      overflow:auto;             /* ëª¨ë‹¬ ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.4);
    }

    .modalHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; position:sticky; top:0; background:var(--card); padding-bottom:10px; }
    .modalTitle{ font-weight:1100; font-size:16px; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); font-size:13px; }
    th{ opacity:.85; }

    .badge{
      display:inline-block; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      font-weight:1000;
    }

    /* login area */
    .loginRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input{
      background:var(--card2); border:1px solid var(--line); color:var(--txt);
      border-radius:12px; padding:12px 12px; outline:none; font-weight:900;
    }
    input::placeholder{ color:rgba(233,238,252,.55); font-weight:900; }

    /* dex grid */
    .dexGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width:840px){ .dexGrid{ grid-template-columns: repeat(3, 1fr);} }
    @media (max-width:560px){ .dexGrid{ grid-template-columns: repeat(2, 1fr);} }
    .dexCard{
      background:var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      min-height:70px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:6px;
    }
    .dexName{ font-weight:1100; font-size:14px; letter-spacing:-0.2px; }
    .dexMeta{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .dexBtn{
      border-radius:10px;
      padding:8px 10px;
      font-weight:1100;
      width:100%;
    }
    .locked{
      opacity:.55;
      filter: grayscale(.2);
    }
    .newTag{
      font-size:12px;
      font-weight:1100;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
    }

    /* online dot */
    .dot{
      width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:8px;
      border:1px solid rgba(255,255,255,.25);
      vertical-align:middle;
    }
    .dot.on{ background: var(--ok); }
    .dot.off{ background: var(--off); }
  </style>
</head>
<body>
  <div class="flash" id="flash"></div>

  <div class="wrap">
    <div class="card">
      <h1>ğŸ² ì´ë¦„ ë½‘ê¸° ìˆ˜ì… ê²Œì„</h1>

      <div class="loginRow">
        <div class="pill">ğŸ‘¤ ë¡œê·¸ì¸: <span id="userLabel">ì—†ìŒ</span></div>
        <input id="nameInput" maxlength="16" placeholder="ë‹‰ë„¤ì„(ìµœëŒ€ 16ì)" />
        <button class="btn2" id="loginBtn">ë¡œê·¸ì¸</button>
        <button class="btn2" id="logoutBtn" disabled>ë¡œê·¸ì•„ì›ƒ</button>
        <span class="small">â€» ì˜¨ë¼ì¸ ë­í‚¹ì€ Firebase(ì„œë²„)ë¡œ ê³µìœ ë¨</span>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="drawBtn" disabled>ì´ë¦„ ë½‘ê¸° (ë¹„ìš© 50)</button>
        <button class="btn2" id="sellBtn" disabled>í˜„ì¬ ì´ë¦„ íŒ”ê¸°</button>
        <button class="btn2" id="dexBtn" disabled>ğŸ“š ë„ê°</button>
        <button class="btn2" id="rankBtn" disabled>ğŸ† ì˜¨ë¼ì¸ ë­í‚¹</button>
        <button class="btn2" id="autoBtn" disabled>ğŸ–±ï¸ ì˜¤í† í´ë¦­: OFF</button>
        <button class="btn2" id="resetBtn" disabled>ë¦¬ì…‹</button>
      </div>

      <div class="stat">
        <div class="pill">ğŸ’° ëˆ: <span id="money">0</span></div>
        <div class="pill">â±ï¸ 5ì´ˆë‹¹ ìˆ˜ì…: <span id="income">0</span></div>
        <div class="pill">ğŸ·ï¸ í˜„ì¬ ì´ë¦„: <span id="currentName">ì—†ìŒ</span></div>
        <div class="pill">â­ ë ˆì–´ë„: <span id="currentRarity">-</span></div>
        <div class="pill">ğŸ“ˆ ì´ ìˆ˜ì… ëˆ„ì : <span id="totalEarned">0</span></div>
        <div class="pill">ğŸ“š ë„ê° ë³´ìœ : <span id="dexCount">0</span>/<span id="dexTotal">0</span></div>
      </div>

      <div class="grid">
        <div class="card" style="background:var(--card2); border-color:var(--line);">
          <div style="font-weight:1100; margin-bottom:8px;">í™•ë¥  & ìˆ˜ì…</div>
          <div class="small" id="ratesBox"></div>
          <div class="small" style="margin-top:8px;">
            ë„ê° ë³´ìƒ: <span class="badge">ìƒˆ ì´ë¦„ íšë“ +10ì›</span> (ì €ì¥ë¨)
          </div>
        </div>
        <div class="card" style="background:var(--card2); border-color:var(--line);">
          <div style="font-weight:1100; margin-bottom:8px;">ì œì•½/ì˜¤í† </div>
          <div class="small">
            - ì—°ì† ë½‘ê¸° ë°©ì§€: ë½‘ê¸° ì§„í–‰ ì¤‘ ë²„íŠ¼ ì ê¹€<br/>
            - ì˜¤í† í´ë¦­: <span class="badge">3ì´ˆë§ˆë‹¤ 1íšŒ</span><br/>
            - ì „ì„¤: ë©‹ìˆê²Œ / ì‹ í™”: ë” ë©‹ìˆê²Œ(ê°•í•œ í”ë“¤ë¦¼+í”Œë˜ì‹œ)
          </div>
        </div>
      </div>

      <div class="stage" id="stage">
        <div class="spinText" id="spinText">ë¡œê·¸ì¸ í›„ ë½‘ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</div>
        <div class="resultBig" id="resultBig"></div>
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>

  <!-- Ranking modal -->
  <div class="modalBack" id="rankBack">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">ğŸ† ì˜¨ë¼ì¸ ë­í‚¹ (ìƒìœ„ 30)</div>
        <button class="btn2" id="rankClose">ë‹«ê¸°</button>
      </div>
      <div class="small" style="margin-top:6px;">
        ê¸°ì¤€: <span class="badge">ì´ ìˆ˜ì…</span> ìš°ì„ , ë™ì ì´ë©´ <span class="badge">ë„ê° ìˆ˜</span> ìš°ì„ .
        <br/>â— ì´ˆë¡ = ì˜¨ë¼ì¸ / â— íšŒìƒ‰ = ì˜¤í”„ë¼ì¸
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th><th>ìƒíƒœ</th><th>ë‹‰ë„¤ì„</th><th>ì´ ìˆ˜ì…</th><th>ë„ê°</th><th>í˜„ì¬ ëˆ</th><th>ìµœê·¼ ì´ë¦„</th>
          </tr>
        </thead>
        <tbody id="rankBody"></tbody>
      </table>
      <div class="small" id="rankHint" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Dex modal -->
  <div class="modalBack" id="dexBack">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">ğŸ“š ë„ê°</div>
        <button class="btn2" id="dexClose">ë‹«ê¸°</button>
      </div>
      <div class="small" style="margin-top:6px;">
        - ì•ˆ ë‚˜ì˜¨ ì´ë¦„ì€ <span class="badge">ì ê¸ˆ</span>ì´ë¼ í´ë¦­ ë¶ˆê°€<br/>
        - ë‚˜ì˜¨ ì´ë¦„ì€ í´ë¦­í•´ì„œ í™•ì¸ ê°€ëŠ¥<br/>
        - â€œNEWâ€ëŠ” ìµœê·¼ ì‹ ê·œ íšë“(ë„ê° ì—´ë©´ NEW ì œê±°)
      </div>
      <div class="dexGrid" id="dexGrid"></div>
    </div>
  </div>

<!-- Firebase (ëª¨ë“ˆ) -->
<script type="module">
  // ===== Firebase SDK (v10.x modular) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, serverTimestamp, getDoc,
    query, collection, orderBy, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    getDatabase, ref, onValue, set, onDisconnect
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey : "AIzaSyA43QjJvd3v_wG77MJyycT3ruuLy42-uZU" , 
  authDomain : "nyam-dbf7d.firebaseapp.com" , 
  databaseURL: "https://nyam-dbf7d-default-rtdb.firebaseio.com",
  projectId: "nyam-dbf7d",
  storageBucket: "nyam-dbf7d.firebasestorage.app",
  messagingSenderId: "724044795848",
  appId: "1:724044795848:web:2601075e917b5c59bebafd",
  measurementId: "G-5088K6G67N"
};

  // ===== ë°¸ëŸ°ìŠ¤ =====
  const DRAW_COST = 50;
  const START_MONEY = 100;
  const DEX_BONUS = 10;
  const AUTO_MS = 3000;
  const INCOME_MS = 5000;

  const RARITIES = [
    { key:"COMMON", label:"ì¼ë°˜", chance:70,   income:  5, sell: 15, cls:"common", tier:1 },
    { key:"RARE",   label:"ë ˆì–´", chance:20,   income: 18, sell: 45, cls:"rareT", tier:2 },
    { key:"EPIC",   label:"ì—í”½", chance: 8,   income: 45, sell:120, cls:"epic",  tier:3 },
    { key:"LEGEND", label:"ì „ì„¤", chance: 1.8, income:130, sell:350, cls:"legend",tier:4 },
    { key:"MYTH",   label:"ì‹ í™”", chance: 0.2, income:350, sell:900, cls:"myth",  tier:5 },
  ];

  const NAME_POOL = {
    COMMON: ["ë¯¼ì¤€","ì„œì¤€","ì§€ë¯¼","ì§€í›ˆ","í˜„ìš°","ë„ìœ¤","ì„œì—°","í•˜ìœ¤","ì§€ì•„","ì˜ˆì¤€","ìœ ì§„","ìˆ˜ë¹ˆ"],
    RARE:   ["ë£¨ì¹´","ì•„ë£¨ì´","ì¹´ì˜¨","ë¦¬ë‚˜","ë°±ì—°","ì´í™”","ë£¨ë„·","ë…¸ë¥´","ë©œë¼","ì—ì‰¬"],
    EPIC:   ["ì•„í‹€ë€í‹°ìŠ¤ì˜ í›„ì˜ˆ","ê²€ì€ í•­í•´ì","ì—¬ëª…ì˜ ì¸ë„ì","ì²­ë¡ì˜ ì¬ë‹¨ì‚¬","í™©í˜¼ì˜ ì„œê¸°ê´€"],
    LEGEND: ["ì´ë¦„ ì—†ëŠ” ì™•","ì‹¬ì—°ì„ ê±·ëŠ” ì","ì‹œê°„ì˜ íŒŒìˆ˜ê¾¼","ë³„ë¹›ì˜ ë§¹ì„¸"],
    MYTH:   ["0ë²ˆì§¸ ì¸ê°„","í˜„ì‹¤ì„ í¸ì§‘í•˜ëŠ” ì","ì„¸ê³„ì„ ì˜ ê´€ë¦¬ì"],
  };

  const DEX_ALL = (() => {
    const arr = [];
    for (const r of RARITIES){
      for (const n of (NAME_POOL[r.key] || [])){
        arr.push({ name:n, rarityKey:r.key });
      }
    }
    return arr;
  })();

  // ===== ë¡œì»¬ ì €ì¥ =====
  const KEY_USER = "ng_user";
  const KEY_SAVE_PREFIX = "ng_save_";

  let userName = null;
  let state = null;
  let incomeTimer = null;
  let autoTimer = null;
  let autoOn = false;
  let drawLock = false;

  // ===== Firebase ì „ì—­ =====
  let app, auth, db, rtdb;
  let uid = null;
  let presenceUnsub = null;
  const onlineMap = new Map(); // name -> boolean

  // ===== DOM =====
  const $ = (id) => document.getElementById(id);
  const fmt = (n) => Math.floor(n).toLocaleString("ko-KR");

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function log(msg){
    const el = $("log");
    const now = new Date();
    const stamp = now.toLocaleTimeString("ko-KR",{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    el.textContent = `[${stamp}] ${msg}\n` + el.textContent;
  }

  // ===== ì´í™íŠ¸ =====
  function spawnSparks(count=16){
    const stage = $("stage");
    const rect = stage.getBoundingClientRect();
    for (let i=0;i<count;i++){
      const s = document.createElement("div");
      s.className = "spark";
      const x = Math.random()*(rect.width-10);
      const y = 20 + Math.random()*(rect.height-40);
      const dx = (-1 + Math.random()*2) * (60 + Math.random()*140);
      const dy = (-1 + Math.random()*2) * (40 + Math.random()*160);
      s.style.left = x + "px";
      s.style.top  = y + "px";
      s.style.setProperty("--dx", dx+"px");
      s.style.setProperty("--dy", dy+"px");
      stage.appendChild(s);
      setTimeout(()=>s.remove(), 700);
    }
  }
  function flash(level){
    const f = $("flash");
    f.classList.remove("on1","on2");
    f.classList.add(level === 2 ? "on2" : "on1");
    setTimeout(()=>f.classList.remove("on1","on2"), 160);
  }
  function shake(level){
    document.body.classList.remove("shakeLegend","shakeMyth");
    void document.body.offsetWidth;
    document.body.classList.add(level === 2 ? "shakeMyth" : "shakeLegend");
    setTimeout(()=>document.body.classList.remove("shakeLegend","shakeMyth"), level === 2 ? 950 : 750);
  }
  async function drawAnimation(){
    const spin = $("spinText");
    const res = $("resultBig");
    res.textContent = "";
    const words = ["ì´ë¦„ì„ ê³ ë¥´ëŠ” ì¤‘â€¦","ìš´ëª…ì„ ì„ëŠ” ì¤‘â€¦","ë ˆì–´ë„ë¥¼ ê³„ì‚° ì¤‘â€¦","ë„ê° í™•ì¸ ì¤‘â€¦","ê±°ì˜ ëë‹¤!"];
    for (let i=0;i<10;i++){
      spin.textContent = words[i % words.length];
      spin.style.transform = `translateY(${(i%2===0? -3:3)}px)`;
      spin.style.opacity = String(0.75 + Math.random()*0.25);
      spawnSparks(4);
      await new Promise(r=>setTimeout(r, 85));
    }
    spin.style.transform = "translateY(0)";
    spin.style.opacity = "1";
  }

  // ===== ëœë¤ =====
  function pickRarity(){
    const r = Math.random() * 100;
    let acc = 0;
    for (const it of RARITIES){
      acc += it.chance;
      if (r <= acc) return it;
    }
    return RARITIES[RARITIES.length - 1];
  }
  function pickNameByRarity(key){
    const arr = NAME_POOL[key] || [];
    return arr.length ? arr[Math.floor(Math.random()*arr.length)] : "(ì´ë¦„ ì—†ìŒ)";
  }

  // ===== ë¡œì»¬ ì €ì¥ =====
  function saveKeyFor(u){ return KEY_SAVE_PREFIX + u; }
  function defaultState(){
    return {
      money: START_MONEY,
      income: 0,
      current: null, // {name, rarityKey}
      totalEarned: 0,
      dexFound: [],
      dexNew: [],
      lastName: "",
      lastRarityKey: "",
      lastSavedAt: Date.now(),
    };
  }
  function loadUserState(u){
    const raw = localStorage.getItem(saveKeyFor(u));
    if (!raw) return defaultState();
    try{
      const parsed = JSON.parse(raw);
      return { ...defaultState(), ...parsed };
    }catch{
      return defaultState();
    }
  }
  function saveUserState(){
    if (!userName || !state) return;
    state.lastSavedAt = Date.now();
    localStorage.setItem(saveKeyFor(userName), JSON.stringify(state));
  }

  // ===== Firebase: init/auth/presence/leaderboard =====
  function safeKey(s){
    // Firestore doc idì— ìœ„í—˜í•œ ë¬¸ì ì œê±°(ìŠ¬ë˜ì‹œ ë“±)
    return String(s).trim().slice(0,16).replaceAll("/", "_");
  }

  async function initFirebase(){
    // config ë¹„ì–´ìˆìœ¼ë©´ ì˜¨ë¼ì¸ ê¸°ëŠ¥ ì•ˆ ë¨
    if (!firebaseConfig || !firebaseConfig.apiKey){
      log("âš ï¸ firebaseConfigê°€ ë¹„ì–´ìˆì–´ì„œ ì˜¨ë¼ì¸ ë­í‚¹ì´ ë¹„í™œì„±í™”ë¨.");
      return;
    }
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    rtdb = getDatabase(app);

    await signInAnonymously(auth);

    onAuthStateChanged(auth, (u)=>{
      if (!u) return;
      uid = u.uid;
      // ë¡œê·¸ì¸ í›„ ì´ë¦„ì´ ì •í•´ì§€ë©´ presence ë“±ë¡í•  ê²ƒ(ì•„ë˜ login()ì—ì„œ)
    });
  }

  async function setPresenceOnline(name){
    if (!rtdb || !uid) return;
    const myRef = ref(rtdb, `presence/${safeKey(name)}`);
    await set(myRef, { online:true, ts: Date.now() });
    onDisconnect(myRef).set({ online:false, ts: Date.now() });
  }

  function watchPresence(){
    if (!rtdb) return;
    const allRef = ref(rtdb, "presence");
    if (presenceUnsub) presenceUnsub();
    presenceUnsub = onValue(allRef, (snap)=>{
      onlineMap.clear();
      const val = snap.val() || {};
      for (const [k, v] of Object.entries(val)){
        onlineMap.set(k, !!v?.online);
      }
      // ë­í‚¹ì´ ì—´ë ¤ìˆë‹¤ë©´ ë°”ë¡œ ê°±ì‹  ëŠë‚Œ ì£¼ê¸° ìœ„í•´ ë‹¤ì‹œ ë Œë” ì‹œë„
      if ($("rankBack").classList.contains("show")){
        openRanking(); // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
      }
    });
  }

  async function syncLeaderboard(){
    if (!db || !userName || !state) return;
    const dexCount = new Set(state.dexFound).size;
    // players ì»¬ë ‰ì…˜ì— ë‚´ ê¸°ë¡ ì €ì¥(ì´ê²Œ â€œì˜¨ë¼ì¸ ë­í‚¹â€ ë°ì´í„°)
    const playerRef = doc(db, "players", safeKey(userName));
    await setDoc(playerRef, {
      name: userName,
      totalEarned: state.totalEarned,
      dexCount,
      money: state.money,
      lastName: state.lastName || "",
      updatedAt: serverTimestamp(),
    }, { merge:true });
  }

  async function openRanking(){
    if (!db){
      $("rankHint").textContent = "ì˜¨ë¼ì¸ ë­í‚¹ì´ ë¹„í™œì„±í™”ë¨ (firebaseConfigë¥¼ ì„¤ì •í•´ì•¼ í•¨)";
      $("rankBack").classList.add("show");
      $("rankBody").innerHTML = "";
      return;
    }

    $("rankHint").textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
    $("rankBody").innerHTML = "";

    const q = query(
      collection(db, "players"),
      orderBy("totalEarned", "desc"),
      orderBy("dexCount", "desc"),
      orderBy("money", "desc"),
      limit(30)
    );

    const snap = await getDocs(q);

    let idx = 0;
    snap.forEach((docu)=>{
      idx++;
      const p = docu.data();
      const nameKey = safeKey(p.name || docu.id);
      const isOn = onlineMap.get(nameKey) === true;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx}</td>
        <td><span class="dot ${isOn ? "on" : "off"}"></span></td>
        <td><span class="badge">${escapeHtml(p.name || docu.id)}</span></td>
        <td>${fmt(p.totalEarned || 0)}</td>
        <td>${p.dexCount ?? 0}</td>
        <td>${fmt(p.money || 0)}</td>
        <td>${escapeHtml(p.lastName ? `"${p.lastName}"` : "-")}</td>
      `;
      $("rankBody").appendChild(tr);
    });

    $("rankHint").textContent = "ìƒìœ„ 30ëª…ë§Œ í‘œì‹œë©ë‹ˆë‹¤.";
    $("rankBack").classList.add("show");
  }

  function closeRanking(){ $("rankBack").classList.remove("show"); }

  // ===== ë„ê° =====
  function renderDexGrid(){
    const grid = $("dexGrid");
    grid.innerHTML = "";
    const foundSet = new Set(state.dexFound);
    const newSet = new Set(state.dexNew);

    DEX_ALL.forEach((item) => {
      const rarity = RARITIES.find(r=>r.key===item.rarityKey);
      const isFound = foundSet.has(item.name);
      const isNew = newSet.has(item.name);

      const card = document.createElement("div");
      card.className = "dexCard" + (isFound ? "" : " locked");

      const nameLine = document.createElement("div");
      nameLine.className = "dexName";
      nameLine.innerHTML = isFound
        ? `<span class="rare ${rarity.cls}">${escapeHtml(item.name)}</span>`
        : `ğŸ”’ ì ê¸ˆ`;

      const meta = document.createElement("div");
      meta.className = "dexMeta";
      meta.innerHTML = `<span class="badge">${rarity.label}</span>${isNew ? `<span class="newTag">NEW</span>` : ``}`;

      const btn = document.createElement("button");
      btn.className = "btn2 dexBtn";
      btn.textContent = isFound ? "ì—´ê¸°" : "ì ê¹€";
      btn.disabled = !isFound;
      btn.addEventListener("click", ()=>{
        alert(`[${rarity.label}] ${item.name}\n\në„ê°ì—ì„œ íšë“í•œ ì´ë¦„ì…ë‹ˆë‹¤.`);
      });

      card.appendChild(nameLine);
      card.appendChild(meta);
      card.appendChild(btn);
      grid.appendChild(card);
    });

    $("dexCount").textContent = String(foundSet.size);
    $("dexTotal").textContent = String(DEX_ALL.length);
  }

  function openDex(){
    renderDexGrid();
    state.dexNew = []; // ë„ê° ì—´ë©´ NEW ì œê±°
    saveUserState();
    // ë­í‚¹ì—ë„ ë°˜ì˜ë  ìˆ˜ ìˆìœ¼ë‹ˆ ì €ì¥ê²¸ ë™ê¸°í™”
    syncLeaderboard().catch(()=>{});
    $("dexBack").classList.add("show");
  }
  function closeDex(){ $("dexBack").classList.remove("show"); }

  // ===== UI =====
  function renderRates(){
    $("ratesBox").innerHTML = RARITIES.map(r =>
      `- <span class="rare ${r.cls}">${r.label}</span>: ${r.chance}% Â· 5ì´ˆë‹¹ +${r.income} Â· íŒë§¤ê°€ ${r.sell}`
    ).join("<br/>");
  }
  function setCurrentDisplay(){
    if (!state.current){
      $("currentName").textContent = "ì—†ìŒ";
      $("currentRarity").textContent = "-";
      $("income").textContent = "0";
      $("sellBtn").disabled = true;
      return;
    }
    const rarity = RARITIES.find(r=>r.key===state.current.rarityKey);
    $("currentName").textContent = state.current.name;
    $("currentRarity").innerHTML = `<span class="rare ${rarity.cls}">${rarity.label}</span>`;
    $("income").textContent = fmt(state.income);
    $("sellBtn").disabled = false;
  }
  function render(){
    $("money").textContent = fmt(state.money);
    $("income").textContent = fmt(state.income);
    $("totalEarned").textContent = fmt(state.totalEarned);

    const foundCount = new Set(state.dexFound).size;
    $("dexCount").textContent = String(foundCount);
    $("dexTotal").textContent = String(DEX_ALL.length);

    $("drawBtn").disabled = drawLock || (state.money < DRAW_COST);
  }
  function setLoggedInUI(on){
    $("userLabel").textContent = on ? userName : "ì—†ìŒ";
    $("drawBtn").disabled = !on || drawLock || (state && state.money < DRAW_COST);
    $("sellBtn").disabled = !on || !state?.current;
    $("dexBtn").disabled = !on;
    $("rankBtn").disabled = !on;
    $("autoBtn").disabled = !on;
    $("resetBtn").disabled = !on;
    $("logoutBtn").disabled = !on;
    $("loginBtn").disabled = on;
    $("nameInput").disabled = on;

    $("spinText").textContent = on ? "ì¤€ë¹„ ì™„ë£Œ! ë½‘ê¸°ë¥¼ ëˆŒëŸ¬ ì‹œì‘." : "ë¡œê·¸ì¸ í›„ ë½‘ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.";
    $("resultBig").textContent = "";
  }

  // ===== ë£¨í”„ =====
  function startIncomeLoop(){
    if (incomeTimer) clearInterval(incomeTimer);
    incomeTimer = setInterval(()=>{
      if (!userName || !state) return;
      if (state.income > 0){
        state.money += state.income;
        state.totalEarned += state.income;
        render();
        saveUserState();
        syncLeaderboard().catch(()=>{});
      }
    }, INCOME_MS);
  }
  function startAutoLoop(){
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = setInterval(()=>{
      if (!autoOn) return;
      if (!userName || !state) return;
      if (drawLock) return;
      if (state.money < DRAW_COST) return;
      doDraw();
    }, AUTO_MS);
  }
  function setAuto(on){
    autoOn = on;
    $("autoBtn").textContent = `ğŸ–±ï¸ ì˜¤í† í´ë¦­: ${autoOn ? "ON" : "OFF"}`;
    log(autoOn ? "ì˜¤í† í´ë¦­ ON (3ì´ˆë§ˆë‹¤)" : "ì˜¤í† í´ë¦­ OFF");
  }

  // ===== ë½‘ê¸°/íŒë§¤ =====
  async function doDraw(){
    if (!userName || !state) return;
    if (drawLock) return;
    if (state.money < DRAW_COST) return;

    drawLock = true;
    render();

    state.money -= DRAW_COST;
    render();
    saveUserState();
    syncLeaderboard().catch(()=>{});

    await drawAnimation();

    const rarity = pickRarity();
    const name = pickNameByRarity(rarity.key);

    state.current = { name, rarityKey: rarity.key };
    state.income = rarity.income;
    state.lastName = name;
    state.lastRarityKey = rarity.key;

    // ë„ê° ì‹ ê·œ ë³´ìƒ +10
    const foundSet = new Set(state.dexFound);
    if (!foundSet.has(name)){
      foundSet.add(name);
      state.dexFound = Array.from(foundSet);

      const newSet = new Set(state.dexNew);
      newSet.add(name);
      state.dexNew = Array.from(newSet);

      state.money += DEX_BONUS;
      log(`ğŸ“š ë„ê° ì‹ ê·œ! "${name}" (+${DEX_BONUS}ì›)`);
    }

    setCurrentDisplay();

    $("spinText").textContent = "ê²°ê³¼!";
    $("resultBig").innerHTML = `<span class="rare ${rarity.cls}">[${rarity.label}]</span> "${escapeHtml(name)}" Â· 5ì´ˆë‹¹ +${fmt(rarity.income)}`;

    if (rarity.key === "MYTH"){
      spawnSparks(44); flash(2); shake(2);
      log(`ğŸŒŒ ì‹ í™” íšë“! "${name}"`);
    } else if (rarity.key === "LEGEND"){
      spawnSparks(30); flash(1); shake(1);
      log(`âœ¨ ì „ì„¤ íšë“! "${name}"`);
    } else {
      spawnSparks(16);
      log(`ë½‘ê¸° ì„±ê³µ! [${rarity.label}] "${name}"`);
    }

    render();
    saveUserState();
    syncLeaderboard().catch(()=>{});

    setTimeout(()=>{
      drawLock = false;
      render();
    }, 450);
  }

  function doSell(){
    if (!userName || !state?.current) return;
    const rarity = RARITIES.find(r=>r.key===state.current.rarityKey);
    const gain = rarity?.sell ?? 0;
    const soldName = state.current.name;

    state.money += gain;
    state.current = null;
    state.income = 0;

    setCurrentDisplay();
    render();
    log(`íŒë§¤ ì™„ë£Œ: "${soldName}" ( +${gain} )`);
    saveUserState();
    syncLeaderboard().catch(()=>{});
  }

  function doReset(){
    if (!userName) return;
    if (!confirm("ì •ë§ ë¦¬ì…‹í• ê¹Œìš”? (í˜„ì¬ ìœ ì € ë°ì´í„°ê°€ ì´ˆê¸°í™”ë¨)")) return;

    state = defaultState();
    localStorage.setItem(saveKeyFor(userName), JSON.stringify(state));
    drawLock = false;
    setAuto(false);

    setCurrentDisplay();
    render();
    renderDexGrid();
    log("ë¦¬ì…‹ ì™„ë£Œ!");
    saveUserState();
    syncLeaderboard().catch(()=>{});
  }

  // ===== ë¡œê·¸ì¸ =====
  function normalizeName(s){
    return (s || "").trim().replace(/\s+/g," ").slice(0,16);
  }

  async function login(name){
    const n = normalizeName(name);
    if (!n){ alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜!"); return; }

    userName = n;
    localStorage.setItem(KEY_USER, userName);
    state = loadUserState(userName);

    drawLock = false;
    setAuto(false);

    setCurrentDisplay();
    render();
    setLoggedInUI(true);
    log(`ë¡œê·¸ì¸: ${userName}`);

    startIncomeLoop();
    startAutoLoop();
    saveUserState();

    // ì˜¨ë¼ì¸ ê¸°ëŠ¥: presence + ë­í‚¹ ë™ê¸°í™”
    try{
      await setPresenceOnline(userName);
      watchPresence();
      await syncLeaderboard();
    }catch{
      log("âš ï¸ ì˜¨ë¼ì¸ ì—°ê²° ì‹¤íŒ¨: firebaseConfig / ì„¤ì •(ìµëª…ë¡œê·¸ì¸/DB) í™•ì¸ í•„ìš”");
    }
  }

  function logout(){
    if (!userName) return;
    saveUserState();
    setAuto(false);

    userName = null;
    state = null;
    localStorage.removeItem(KEY_USER);

    setLoggedInUI(false);
    $("money").textContent = "0";
    $("income").textContent = "0";
    $("totalEarned").textContent = "0";
    $("dexCount").textContent = "0";
    $("dexTotal").textContent = String(DEX_ALL.length);

    log("ë¡œê·¸ì•„ì›ƒë¨.");
  }

  // ===== ì´ë²¤íŠ¸ =====
  $("loginBtn").addEventListener("click", ()=> login($("nameInput").value));
  $("nameInput").addEventListener("keydown", (e)=>{ if (e.key === "Enter") login($("nameInput").value); });
  $("logoutBtn").addEventListener("click", logout);

  $("drawBtn").addEventListener("click", doDraw);
  $("sellBtn").addEventListener("click", doSell);
  $("resetBtn").addEventListener("click", doReset);

  $("rankBtn").addEventListener("click", openRanking);
  $("rankClose").addEventListener("click", closeRanking);
  $("rankBack").addEventListener("click", (e)=>{ if (e.target.id === "rankBack") closeRanking(); });

  $("dexBtn").addEventListener("click", openDex);
  $("dexClose").addEventListener("click", closeDex);
  $("dexBack").addEventListener("click", (e)=>{ if (e.target.id === "dexBack") closeDex(); });

  $("autoBtn").addEventListener("click", ()=>{
    if (!userName) return;
    setAuto(!autoOn);
  });

  // ===== ì´ˆê¸°í™” =====
  renderRates();
  $("dexTotal").textContent = String(DEX_ALL.length);

  await initFirebase();

  const remembered = localStorage.getItem(KEY_USER);
  if (remembered){
    // ìë™ ë¡œê·¸ì¸
    await login(remembered);
    log(`ìë™ ë¡œê·¸ì¸: ${remembered}`);
  } else {
    setLoggedInUI(false);
    $("dexCount").textContent = "0";
  }
</script>
</body>
</html>
